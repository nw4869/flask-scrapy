{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% from "_formhelpers.html" import render_field, with_errors %}

{% block page_content %}
    <div class="page-header">
        <h2>{{ task.name }} &nbsp;
            <a class="btn btn-primary" role="button" href="{{ url_for('task.start', task_id=task.id) }}">启动任务</a></h2>
    </div>

    <table class="table table-striped">
        <caption>起始链接</caption>
        <thead>
        <tr>
            <th class="col-sm-1">序号</th>
            <th class="col-sm-2">链接</th>
        </tr>
        </thead>
        <tbody>
        {% for i in range(start_urls|count) %}
            <tr>
                <td>{{ i + 1 }}</td>
                <td>{{ start_urls[i].rule1 }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <hr>

    <table class="table table-striped">
        <caption>链接规则</caption>
        <thead>
        <tr>
            <th class="col-sm-1">序号</th>
            <th class="col-sm-2">规则</th>
        </tr>
        </thead>
        <tbody>
        {% for i in range(link_rules|count) %}
            <tr>
                <td>{{ i + 1 }}</td>
                <td>{{ link_rules[i].rule1 }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <hr>

    <table class="table table-striped">
        <caption>标签列表 &nbsp;
            <button class="btn btn-success btn-sm" data-toggle="modal"
                    data-target="#add_tag_modal">添加标签
            </button>
        </caption>
        <thead>
        <tr>
            <th class="col-sm-1">序号</th>
            <th class="col-sm-1">名称</th>
            <th class="col-sm-2">规则</th>
            <th class="col-sm-1">操作</th>
        </tr>
        </thead>
        <tbody id="tags_list">

        {% for i in range(tags|count) %}
            <tr>
                <td>{{ i + 1 }}</td>
                <td> {{ tags[i].name }} </td>
                <td> {{ tags[i].rule1 }} </td>
                <td><a class="btn btn-danger btn-sm" role="button"
                       href="{{ url_for('task.remove_tag', task_id=task.id, tag_id=tags[i].id) }}">删除</a></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {#    添加标签模态框#}
    <div class="modal fade" id="add_tag_modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title">
                        添加标签
                    </h4>
                </div>
                <div class="modal-body">
                    <form id="new_tag_form" action method="post" role="form" class="form-horizontal">
                        {{ new_tag_form.csrf_token }}
                        {# 名称 #}
                        <div class="form-group">
                            {{ new_tag_form.name.label(class="control-label col-sm-2") }}
                            <div class="col-sm-4">
                                {{ with_errors(new_tag_form.name, class="form-control") }}
                            </div>
                        </div>
                        {# 类型 #}
                        <div class="form-group">
                            {{ new_tag_form.type.label(class="control-label col-sm-2") }}
                            <div class="col-sm-4">
                                {{ with_errors(new_tag_form.type, class="form-control") }}
                            </div>
                        </div>
                        {#规则1#}
                        <div class="form-group">
                            {{ new_tag_form.rule1.label(class="control-label col-sm-2") }}
                            <div class="col-sm-4">
                                {{ with_errors(new_tag_form.rule1, class="form-control") }}
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal">关闭</button>
                    {{ new_tag_form.submit(class="btn btn-success", id="commit_add_tag") }}
                </div>
            </div>
        </div>
    </div>

    <hr>


    <table id="result_table" class="table table-striped">
        <caption>任务结果 &nbsp;
            <button id="btn_refresh_result" class="btn btn-primary btn-sm">刷新结果</button>
            &nbsp;
            <span>loading...</span>
        </caption>
        <thead>
        <tr>
            {#            <th class="col-sm-1">序号</th>#}
            {#            {% for tag in tags %}#}
            {#                <th class="col-sm-2">{{ tag.name }}</th>#}
            {#            {% endfor %}#}
            {#            <th class="col-sm-2">来源</th>#}
            {#            <th class="col-sm-2">日期</th>#}
        </tr>
        </thead>
        <tbody>
        {#        {% for i in range(results|count) %}#}
        {#            <tr>#}
        {#                <td>{{ i + 1 }}</td>#}
        {#                {% for item in results[i].items %}#}
        {#                    <td><a href="{{ url_for('task.item_detail', task_id=task.id, item_id=item.id) }}">#}
        {#                        {{ item.data[:100] if item is not none }}</a></td>#}
        {#                {% endfor %}#}
        {#                <td><a href="{{ results[i].url }}">{{ results[i].url[:100] }}</a></td>#}
        {#                <td>{{ results[i].datetime }}</td>#}
        {#            </tr>#}
        {#        {% endfor %}#}

        </tbody>
        <tfoot>
        <tr>
            <td>loading...</td>
        </tr>
        </tfoot>
    </table>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function () {
            // 设置“添加标签”按钮响应函数
            $("#commit_add_tag").click(function () {
                $.ajax({
                    url: '{{ url_for('task.new_tag', task_id=task.id) }}',
                    data: $("#new_tag_form").serialize(),
                    type: 'POST',
                    success: function (response) {
                        console.log(response);
                        var tag = response['tag'];
                        $("#tags_list").append(new_tag(tag['id'], tag['name'], tag['rule1']));
                        $("#add_tag_modal").modal('hide');
                        $("#message_box").append(make_message('添加成功', 'success'))
                    },
                    error: function (error) {
                        console.error(error);
                        $("#add_tag_modal").find(".modal-body").append(make_message("添加失败", "warning"))
                    }
                })
            });
            // 设置“刷新结果”按钮响应函数
            $("#btn_refresh_result").click(pull_and_refresh_result);
            // 异步拉取任务结果
            pull_and_refresh_result();
        });
        function new_tag(id, name, rule1) {
            return '<tr>\
                 <td>' + id + '</td>\
                <td>' + name + '</td>\
                <td>' + rule1 + '</td>\
                <td><a href="\
                {{ url_for('task.remove_tag', task_id=task.id, tag_id='') }}' + id + '">删除</a></td>\
            </tr>'
        }
        function make_message(message, type) {
            return '<div class="alert alert-' + type + '">\
                    <button type="button" class="close" data-dismiss="alert">&times;</button>'
                    + message +
                    '</div>'
        }
        function pull_results(task_id, callback) {
            var url = '{{ url_for("task.results", task_id=99999999) }}';
            url = url.replace(/99999999/, task_id);
            return $.getJSON(url, callback);
        }
        function refresh_results(results, tags) {
            var resultTable = $("#result_table");

            {#            设置信息#}
            resultTable.find("caption > span").text('done.').fadeOut("slow");

            {#             设置标题#}
            var title = resultTable.find("> thead > tr");
            title.empty();
            $("<th>").attr("class", "col-sm-1").text('序号').appendTo(title);
            $.each(tags, function (i, tag) {
                $("<th>").attr("class", "col-sm-2").text(tag.name).appendTo(title);
            });
            $("<th>").attr("class", "col-sm-2").text('来源').appendTo(title);
            $("<th>").attr("class", "col-sm-2").text('日期').appendTo(title);

            {#            设置内容#}
            var content = resultTable.find("tbody");
            content.empty();
            {#            resultTable.hide().slideDown();#}
            $.each(results, function (i, result) {
                var row = $("<tr>").appendTo(content);
                $("<td>").text(result.id).appendTo(row);
                $.each(result.items, function (j, item) {
                    var item_url = "{{ url_for('task.item_detail', task_id=task.id, item_id=99999999) }}"
                            .replace(/99999999/, item.id);
                    $("<td>").append($("<a>").attr("href", item_url).text(item.data.substr(0, 100))).appendTo(row);
                });
                $("<td>").append($("<a>").attr("href", result.url).text(result.url.substr(0, 100))).appendTo(row);
                $("<td>").text(result.datetime).appendTo(row);
            });
        }
        function pull_and_refresh_result() {
            var info_box = $("#result_table").find("caption > span");
            info_box.text('loading...');
            info_box.fadeIn();
            pull_results({{ task.id }}, function (result) {
                refresh_results(result.results, result.tags);
            })
                    .fail(function () {
                        var msg = "获取任务结果失败";
                        console.error(msg);
                        info_box.text(msg);
                        $("#message_box").append(make_message(msg, 'warning'))
                    });
        }
    </script>
{% endblock %}
